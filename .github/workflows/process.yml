name: Data Process

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - uses: actions/checkout@v3

    - name: ğŸ› ï¸ Start Stream (Cloudflare Edition)
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        # Playit à¦à¦° à¦¸à¦¿à¦•à§à¦°à§‡à¦Ÿ à¦†à¦° à¦²à¦¾à¦—à¦¬à§‡ à¦¨à¦¾
      run: |
        # ========================================================
        # 1. CLOUDFLARE TUNNEL INSTALL & START
        # ========================================================
        echo ">>> [1/5] Setting up Cloudflare Tunnel..."
        
        # Cloudflare à¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡
        curl -L -o cloudflared-linux-amd64 "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
        chmod +x cloudflared-linux-amd64
        
        # à¦Ÿà¦¾à¦¨à§‡à¦² à¦°à¦¾à¦¨ à¦•à¦°à¦¾ (8080 à¦ªà§‹à¦°à§à¦Ÿà§‡à¦° à¦œà¦¨à§à¦¯)
        nohup ./cloudflared-linux-amd64 tunnel --url http://localhost:8080 > cf.log 2>&1 &
        
        echo "â³ Waiting for Cloudflare URL (10s)..."
        sleep 10
        
        # à¦²à¦— à¦¥à§‡à¦•à§‡ à¦²à¦¿à¦‚à¦• à¦¬à§‡à¦° à¦•à¦°à¦¾
        CF_URL=$(grep -o 'https://.*\.trycloudflare.com' cf.log | head -1)
        
        if [ -z "$CF_URL" ]; then
            echo "âŒ Error: Cloudflare link not found. Retrying..."
            sleep 5
            CF_URL=$(grep -o 'https://.*\.trycloudflare.com' cf.log | head -1)
        fi
        
        if [ -z "$CF_URL" ]; then
            echo "âŒ CRITICAL: Tunnel failed!"
            cat cf.log
            exit 1
        fi
        
        echo "âœ… Tunnel Live: $CF_URL"
        
        # ========================================================
        # 2. UPDATE WORKER DATABASE
        # ========================================================
        echo ">>> [2/5] Updating Worker with URL..."
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$CF_URL"
        
        # ========================================================
        # 3. BUILD BOT
        # ========================================================
        echo ">>> [3/5] Building Bot..."
        export PATH=$PATH:/usr/local/go/bin
        
        # à¦•à§à¦²à¦¿à¦¨à¦†à¦ª
        if [ -d "TG-FileStream" ]; then rm -rf TG-FileStream; fi
        
        # à¦•à§à¦²à§‹à¦¨ à¦“ à¦¬à¦¿à¦²à§à¦¡
        git clone https://github.com/affaz101/TG-FileStream
        cd TG-FileStream
        go mod download
        CGO_ENABLED=0 go build -o fsb -ldflags="-w -s" ./cmd/fsb
        chmod +x fsb
        
        # ========================================================
        # 4. FETCH CONFIG
        # ========================================================
        echo ">>> [4/5] Fetching Settings..."
        SECRETS_JSON=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        export API_ID=$(echo $SECRETS_JSON | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS_JSON | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS_JSON | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS_JSON | jq -r '.data.LOG_CHANNEL')
        
        # ========================================================
        # 5. START BOT
        # ========================================================
        export PORT=8080
        export HOST="$CF_URL"
        export USE_SESSION_FILE=false
        
        echo ">>> [5/5] ğŸš€ Starting Bot..."
        echo "ğŸ”— Public Link: $HOST"
        
        ./fsb run
