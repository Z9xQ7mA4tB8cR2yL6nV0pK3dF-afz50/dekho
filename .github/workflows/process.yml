name: Data Processing

on:
  workflow_dispatch: # ‡¶è‡¶ü‡¶æ ‡¶Æ‡¶æ‡¶®‡ßá ‡¶π‡¶≤‡ßã API ‡¶¶‡¶ø‡ßü‡ßá ‡¶¨‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá

jobs:
  stream-job:
    runs-on: ubuntu-latest
    timeout-minutes: 300 # ‡ß´ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶™‡¶∞ ‡¶Ö‡¶ü‡ßã ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá (‡¶∏‡ßá‡¶´‡¶ü‡¶ø)

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    - name: Install Dependencies & Cloudflared
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        # Cloudflared ‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Clone & Build Bot
      run: |
        # ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã ‡¶ï‡ßç‡¶≤‡ßã‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        git clone https://github.com/affaz101/TG-FileStream bot
        cd bot
        go mod tidy
        go build -o fsb ./cmd/fsb

    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
      run: |
        # ‡ßß. ‡¶ü‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶™‡ßã‡¶∞‡ßç‡¶ü 8080)
        cloudflared tunnel --url http://127.0.0.1:8080 > cf.log 2>&1 &
        PID_CF=$!
        echo "‚è≥ Tunnel Starting..."
        sleep 8
        
        # ‡ß®. ‡¶ü‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' cf.log | head -1)
        echo "üîó Tunnel URL: $TUNNEL_URL"
        
        # ‡ß©. ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$TUNNEL_URL"
        
        # ‡ß™. ‡¶¨‡¶ü ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡¶æ (‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü‡¶≤‡¶ø)
        # ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßç‡¶∞‡ßá‡¶°‡ßá‡¶®‡¶∂‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ü‡¶®‡¶õ‡¶ø
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        export HOST=$WORKER_URL
        
        # ‡ß´. ‡¶¨‡¶ü ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ
        cd bot
        ./fsb run
