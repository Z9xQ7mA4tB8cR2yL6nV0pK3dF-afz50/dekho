name: Data Process

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - uses: actions/checkout@v3

    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        PLAYIT_URL: ${{ secrets.PLAYIT_URL }}
      run: |
        # ‡ßß. Playit ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo apt-key add -
        sudo curl -SsL -o /etc/apt/sources.list.d/playit-cloud.list https://playit-cloud.github.io/ppa/playit-cloud.list
        sudo apt-get update
        sudo apt-get install playit
        
        # ‡ß®. Playit ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü (Silent Mode)
        nohup playit --secret $PLAYIT_SECRET > /dev/null 2>&1 &
        echo "‚è≥ Playit Starting... Please wait 15s..."
        sleep 15
        
        # ‡ß©. Worker ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$PLAYIT_URL"
        
        # ‡ß™. ‡¶¨‡¶ü ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶ì ‡¶∞‡¶æ‡¶®
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        
        # ‚ö†Ô∏è ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø‡¶á ‡¶Ü‡¶∏‡¶≤ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® (‡¶Ü‡¶ó‡ßá ‡¶è‡¶ü‡¶æ ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤):
        export HOST=$PLAYIT_URL
        
        echo "üöÄ Starting Bot with HOST: $HOST"
        
        cd bot
        ./fsb run
