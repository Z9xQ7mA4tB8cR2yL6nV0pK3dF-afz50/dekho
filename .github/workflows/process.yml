name: Data Process

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - uses: actions/checkout@v3

    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        PLAYIT_URL: ${{ secrets.PLAYIT_URL }}
      run: |
        # рзз. Playit ржЗржирзНрж╕ржЯрж▓ ржУ рж╕рзНржЯрж╛рж░рзНржЯ
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo apt-key add -
        sudo curl -SsL -o /etc/apt/sources.list.d/playit-cloud.list https://playit-cloud.github.io/ppa/playit-cloud.list
        sudo apt-get update
        sudo apt-get install playit
        nohup playit --secret $PLAYIT_SECRET > /dev/null 2>&1 &
        echo "тП│ Playit Started..."
        sleep 10
        
        # рзи. Worker ржЖржкржбрзЗржЯ
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$PLAYIT_URL"
        
        # рзй. ржмржЯ ржлрж╛ржЗрж▓ ржбрж╛ржЙржирж▓рзЛржб (ржЖржкржирж╛рж░ ржкрж┐рж╕рж┐рждрзЗ ржерж╛ржХрж╛ рж▓рж╛ржЧржмрзЗ ржирж╛, ржПржЯрж╛ ржЕржЯрзЛ ржирж╛ржоржмрзЗ)
        echo "тмЗя╕П Downloading Bot Binary..."
        wget -O fsb https://github.com/EverythingSuckz/TG-FileStreamBot/releases/download/v3.1.0/fsb_linux_amd64
        chmod +x fsb
        
        # рзк. ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рж╕рзЗржЯржЖржк
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        export HOST=$PLAYIT_URL
        
        echo "ЁЯЪА Starting Bot with HOST: $HOST"
        ./fsb run
