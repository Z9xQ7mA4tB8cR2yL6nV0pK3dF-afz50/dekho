name: Data Process

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - uses: actions/checkout@v3

    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        PLAYIT_URL: ${{ secrets.PLAYIT_URL }}
      run: |
        # ‡ßß. Playit ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ì ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo apt-key add -
        sudo curl -SsL -o /etc/apt/sources.list.d/playit-cloud.list https://playit-cloud.github.io/ppa/playit-cloud.list
        sudo apt-get update
        sudo apt-get install playit
        nohup playit --secret $PLAYIT_SECRET > /dev/null 2>&1 &
        echo "‚è≥ Playit Starting..."
        sleep 10
        
        # ‡ß®. Worker ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$PLAYIT_URL"
        
        # ‡ß©. ‡¶è‡¶®‡¶≠‡¶æ‡¶Ø‡¶º‡¶∞‡¶®‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        export HOST=$PLAYIT_URL
        
        # ‡ß™. ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ (Smart Fix)
        echo "üîç Searching for 'fsb' file..."
        FSB_FILE=$(find . -type f -name "fsb" | head -n 1)
        
        if [ -z "$FSB_FILE" ]; then
            echo "‚ùå ERROR: 'fsb' file not found! Please upload the bot binary."
            ls -R
            exit 1
        fi
        
        echo "‚úÖ Found fsb at: $FSB_FILE"
        
        # ‡ß´. ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ
        chmod +x "$FSB_FILE"
        cd $(dirname "$FSB_FILE")
        echo "üöÄ Starting Bot with HOST: $HOST"
        ./fsb run
