name: Stream Process

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - uses: actions/checkout@v3

    - name: ðŸš€ High Performance Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
      run: |
        # ========================================================
        # 1. NETWORK OPTIMIZATION (BBR & TCP TWEAKS)
        # ========================================================
        echo ">>> [1/5] Boosting Network Speed..."
        sudo sysctl -w net.core.default_qdisc=fq
        sudo sysctl -w net.ipv4.tcp_congestion_control=bbr
        sudo sysctl -w net.ipv4.tcp_window_scaling=1
        sudo sysctl -w net.core.rmem_max=26214400
        sudo sysctl -w net.core.wmem_max=26214400
        
        # ========================================================
        # 2. CLOUDFLARE TUNNEL (HTTP2 ENABLED)
        # ========================================================
        echo ">>> [2/5] Starting Optimized Tunnel..."
        
        curl -L -o cloudflared-linux-amd64 "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
        chmod +x cloudflared-linux-amd64
        
        # --protocol http2 à¦¯à§‹à¦— à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡ à¦¯à¦¾ à¦¸à§à¦Ÿà§à¦°à¦¿à¦®à¦¿à¦‚à§Ÿà§‡à¦° à¦œà¦¨à§à¦¯ à¦«à¦¾à¦¸à§à¦Ÿ
        nohup ./cloudflared-linux-amd64 tunnel --protocol http2 --url http://localhost:8080 > cf.log 2>&1 &
        
        echo "â³ Waiting for Tunnel (10s)..."
        sleep 10
        
        CF_URL=$(grep -o 'https://.*\.trycloudflare.com' cf.log | head -1)
        
        if [ -z "$CF_URL" ]; then
            echo "âŒ Error: Tunnel failed, retrying..."
            sleep 5
            CF_URL=$(grep -o 'https://.*\.trycloudflare.com' cf.log | head -1)
        fi
        
        if [ -z "$CF_URL" ]; then
            echo "âŒ CRITICAL: Tunnel could not start."
            cat cf.log
            exit 1
        fi
        
        echo "âœ… High Speed Tunnel: $CF_URL"
        
        # ========================================================
        # 3. UPDATE WORKER
        # ========================================================
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$CF_URL"
        
        # ========================================================
        # 4. BUILD BOT
        # ========================================================
        echo ">>> [4/5] Building Bot..."
        export PATH=$PATH:/usr/local/go/bin
        
        if [ -d "TG-FileStream" ]; then rm -rf TG-FileStream; fi
        git clone https://github.com/affaz101/TG-FileStream
        cd TG-FileStream
        go mod download
        CGO_ENABLED=0 go build -o fsb -ldflags="-w -s" ./cmd/fsb
        chmod +x fsb
        
        # ========================================================
        # 5. CONFIGURE & RUN
        # ========================================================
        echo ">>> [5/5] Fetching Config & Running..."
        SECRETS_JSON=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        export API_ID=$(echo $SECRETS_JSON | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS_JSON | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS_JSON | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS_JSON | jq -r '.data.LOG_CHANNEL')
        
        export PORT=8080
        export HOST="$CF_URL"
        export USE_SESSION_FILE=false
        
        ./fsb run
