name: Stream Process

on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - uses: actions/checkout@v3

    - name: ЁЯЫая╕П Setup & Run Everything (Single Step)
      env:
        # рж╕рж┐ржХрзНрж░рзЗржЯржЧрзБрж▓рзЛ ржПржЦрж╛ржи ржерзЗржХрзЗ рж▓рзЛржб рж╣ржмрзЗ
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        PLAYIT_URL: ${{ secrets.PLAYIT_URL }}
      run: |
        # ========================================================
        # 1. PLAYIT INSTALLATION & START
        # ========================================================
        echo ">>> [1/5] Installing & Starting Playit..."
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo apt-key add -
        sudo curl -SsL -o /etc/apt/sources.list.d/playit-cloud.list https://playit-cloud.github.io/ppa/playit-cloud.list
        sudo apt-get update
        sudo apt-get install playit -y
        
        # Playit ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржбрзЗ рж░рж╛ржи ржХрж░рж╛ (Silent Mode)
        nohup playit --secret $PLAYIT_SECRET > /dev/null 2>&1 &
        echo "тП│ Playit warming up (10s)..."
        sleep 10
        
        # ========================================================
        # 2. UPDATE WORKER DATABASE
        # ========================================================
        echo ">>> [2/5] Updating Worker with URL: $PLAYIT_URL"
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$PLAYIT_URL"
        
        # ========================================================
        # 3. BUILD BOT (FROM SOURCE)
        # ========================================================
        echo ">>> [3/5] Downloading & Building Bot..."
        # Go ржкрж░рж┐ржмрзЗрж╢ ржарж┐ржХ ржХрж░рж╛
        export PATH=$PATH:/usr/local/go/bin
        
        # рж░рж┐ржкрзЛ ржХрзНрж▓рзЛржи ржПржмржВ ржлрзЛрж▓рзНржбрж╛рж░рзЗ ржврзЛржХрж╛
        if [ -d "TG-FileStream" ]; then rm -rf TG-FileStream; fi
        git clone https://github.com/affaz101/TG-FileStream
        cd TG-FileStream
        
        # ржмрж┐рж▓рзНржб ржХрж░рж╛ (ржЖржкржирж╛рж░ tool.sh ржПрж░ рж▓ржЬрж┐ржХ)
        go mod download
        CGO_ENABLED=0 go build -o fsb -ldflags="-w -s" ./cmd/fsb
        chmod +x fsb
        
        # ========================================================
        # 4. FETCH SECRETS & CONFIGURE
        # ========================================================
        echo ">>> [4/5] Fetching Config from Worker..."
        SECRETS_JSON=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        # JSON ржерзЗржХрзЗ ржнрзНржпрж╛рж▓рзБ ржмрзЗрж░ ржХрж░рж╛
        export API_ID=$(echo $SECRETS_JSON | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS_JSON | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS_JSON | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS_JSON | jq -r '.data.LOG_CHANNEL')
        
        # тЪая╕П CRITICAL SETTINGS FOR CONNECTION RESET FIX
        export PORT=8080
        export HOST=$PLAYIT_URL
        export USE_SESSION_FILE=false
        
        # ========================================================
        # 5. START BOT
        # ========================================================
        echo ">>> [5/5] ЁЯЪА Starting Bot on PORT $PORT..."
        echo "ЁЯФЧ Public Link: $HOST"
        
        ./fsb run
