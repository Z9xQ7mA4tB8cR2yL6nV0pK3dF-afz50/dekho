name: Data Processing

on:
  workflow_dispatch: # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

jobs:
  stream-job:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡ß¨ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22' # ‚ö†Ô∏è ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: 1.20 ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá 1.22 ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá

    - name: Install Dependencies & Cloudflared
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        # Cloudflared ‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Clone & Build Bot
      run: |
        git clone https://github.com/affaz101/TG-FileStream bot
        cd bot
        # Go mod tidy ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶≤‡ßç‡¶°
        go mod tidy
        go build -o fsb ./cmd/fsb


    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        PLAYIT_URL: ${{ secrets.PLAYIT_URL }}
      run: |
        # ‡ßß. Playit ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo apt-key add -
        sudo curl -SsL -o /etc/apt/sources.list.d/playit-cloud.list https://playit-cloud.github.io/ppa/playit-cloud.list
        sudo apt-get update
        sudo apt-get install playit
        
        # ‡ß®. Playit ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ (Silent Mode - ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶°)
        # nohup ‡¶è‡¶¨‡¶Ç /dev/null ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡ßü ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
        # ‡¶´‡¶≤‡ßá RenderError ‡¶ü‡¶æ ‡¶Ü‡¶∞ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
        nohup playit --secret $PLAYIT_SECRET > /dev/null 2>&1 &
        
        echo "‚è≥ Playit running in background (Silent Mode)..."
        sleep 15
        
        # ‡ß©. ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        echo "üîó Linking to: $PLAYIT_URL"
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$PLAYIT_URL"
        
        # ‡ß™. ‡¶¨‡¶ü ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        
        cd bot
        ./fsb run
        
        cd bot
        ./fsb run
