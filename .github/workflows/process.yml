name: Data Processing

on:
  workflow_dispatch: # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

jobs:
  stream-job:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡ß¨ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22' # ‚ö†Ô∏è ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: 1.20 ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá 1.22 ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá

    - name: Install Dependencies & Cloudflared
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        # Cloudflared ‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Clone & Build Bot
      run: |
        git clone https://github.com/affaz101/TG-FileStream bot
        cd bot
        # Go mod tidy ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶≤‡ßç‡¶°
        go mod tidy
        go build -o fsb ./cmd/fsb


    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }} # ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶®‡¶ø‡¶¨‡ßá
      run: |
        # ‡ßß. Ngrok ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ (Asia Pacific Region - ‡¶∏‡¶ø‡¶ô‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞)
        # ‡¶è‡¶ü‡¶ø ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶´‡¶æ‡¶∏‡ßç‡¶ü ‡¶π‡¶¨‡ßá
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # Ngrok ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        ./ngrok config add-authtoken $NGROK_AUTH_TOKEN
        
        # ‡ß®. ‡¶ü‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü (Region: AP = Asia Pacific)
        ./ngrok http 8080 --region ap --log=stdout > ngrok.log 2>&1 &
        echo "‚è≥ Starting Ngrok (Asia Server)..."
        sleep 8
        
        # ‡ß©. ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        TUNNEL_URL=$(grep -o 'https://[a-z0-9-]*\.ngrok-free\.app' ngrok.log | head -1)
        echo "üîó High Speed Asia URL: $TUNNEL_URL"
        
        if [ -z "$TUNNEL_URL" ]; then
          echo "‚ùå Tunnel Failed! Logs:"
          cat ngrok.log
          exit 1
        fi
        
        # ‡ß™. ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$TUNNEL_URL"
        
        # ‡ß´. ‡¶¨‡¶ü ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        export HOST=$WORKER_URL
        
        cd bot
        ./fsb run
