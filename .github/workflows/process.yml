name: Data Processing

on:
  workflow_dispatch: # ম্যানুয়ালি স্টার্ট করার জন্য

jobs:
  stream-job:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # প্রায় ৬ ঘণ্টা

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22' # ⚠️ ফিক্স: 1.20 এর বদলে 1.22 দেওয়া হয়েছে

    - name: Install Dependencies & Cloudflared
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        # Cloudflared নামানো
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Clone & Build Bot
      run: |
        git clone https://github.com/affaz101/TG-FileStream bot
        cd bot
        # Go mod tidy এবং বিল্ড
        go mod tidy
        go build -o fsb ./cmd/fsb


    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
      run: |
        # ১. Playit ইন্সটল
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo apt-key add -
        sudo curl -SsL -o /etc/apt/sources.list.d/playit-cloud.list https://playit-cloud.github.io/ppa/playit-cloud.list
        sudo apt-get update
        sudo apt-get install playit
        
        # ২. Playit এজেন্ট রান করা
        # এটা রান হলেই Playit ড্যাশবোর্ডে এজেন্ট সবুজ (Online) হয়ে যাবে
        playit --secret $PLAYIT_SECRET > playit.log 2>&1 &
        echo "⏳ Connecting to Playit..."
        sleep 10
        
        # ৩. চেক করা কানেক্ট হলো কিনা
        if grep -q "Tunnel connected" playit.log; then
             echo "✅ Playit Agent is ONLINE!"
        else
             echo "⚠️ Still connecting... Logs:"
             cat playit.log
        fi
        
        # ৪. এখানে আমরা আপাতত লুপে ফেলব যাতে VM বন্ধ না হয় এবং আমরা লিংক সেটআপ করতে পারি
        # লিংক পাওয়ার পর আমরা এটা পরে আপডেট করব
        
        # বট রান করা
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        
        cd bot
        ./fsb run
        
        cd bot
        ./fsb run
