name: Data Processing

on:
  workflow_dispatch: # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

jobs:
  stream-job:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡ß¨ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22' # ‚ö†Ô∏è ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: 1.20 ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá 1.22 ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá

    - name: Install Dependencies & Cloudflared
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        # Cloudflared ‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Clone & Build Bot
      run: |
        git clone https://github.com/affaz101/TG-FileStream bot
        cd bot
        # Go mod tidy ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶≤‡ßç‡¶°
        go mod tidy
        go build -o fsb ./cmd/fsb


    - name: Start Tunnel & Stream
      env:
        WORKER_URL: ${{ secrets.WORKER_URL }}
        WORKER_KEY: ${{ secrets.WORKER_KEY }}
      run: |
        # ‡ßß. localhost.run ‡¶ü‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ (Cloudflare ‡¶è‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ)
        # ‡¶è‡¶ü‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤‡ßá‡¶∂‡¶® ‡¶õ‡¶æ‡ßú‡¶æ‡¶á ‡¶ö‡¶≤‡ßá
        ssh -o StrictHostKeyChecking=no -R 80:localhost:8080 nokey@localhost.run > tunnel.log 2>&1 &
        echo "‚è≥ Tunnel Starting..."
        sleep 10
        
        # ‡ß®. ‡¶ü‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        # localhost.run ‡¶è‡¶∞ ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶•‡ßá‡¶ï‡ßá https ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        TUNNEL_URL=$(grep -o 'https://[a-z0-9-]*\.lhr\.life' tunnel.log | head -1)
        
        # ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™: ‡¶Ø‡¶¶‡¶ø lhr.life ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶®‡¶æ ‡¶¶‡ßá‡ßü, ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ö‡ßá‡¶ï
        if [ -z "$TUNNEL_URL" ]; then
            TUNNEL_URL=$(grep -o 'https://[a-z0-9-]*\.localhost\.run' tunnel.log | head -1)
        fi
        
        echo "üîó Speed Tunnel URL: $TUNNEL_URL"
        
        if [ -z "$TUNNEL_URL" ]; then
          echo "‚ùå Tunnel Failed! Logs:"
          cat tunnel.log
          exit 1
        fi
        
        # ‡ß©. ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        curl -s "$WORKER_URL?key=$WORKER_KEY&update=$TUNNEL_URL"
        
        # ‡ß™. ‡¶¨‡¶ü ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ (‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶Ü‡¶®‡¶æ‡¶∏‡¶π)
        SECRETS=$(curl -s "$WORKER_URL?key=$WORKER_KEY")
        
        export API_ID=$(echo $SECRETS | jq -r '.data.API_ID')
        export API_HASH=$(echo $SECRETS | jq -r '.data.API_HASH')
        export BOT_TOKEN=$(echo $SECRETS | jq -r '.data.BOT_TOKEN')
        export LOG_CHANNEL=$(echo $SECRETS | jq -r '.data.LOG_CHANNEL')
        export PORT=8080
        export HOST=$WORKER_URL
        
        cd bot
        ./fsb run
        
        cd bot
        ./fsb run
